<title>Angular Flexi Grid</title>
<div [attr.data-bs-theme]="themeClass" class="flexi-grid-table-container overflow-x" [ngClass]="loading ? 'flexi-grid-disabled-div' : ''" [ngStyle]="{'width': autoWidth ? '100%' : width, 'font-size': fontSize}">
  @if(showCaption){
    <div class="flexi-grid-caption-div">
      <span class="flexi-grid-caption-title">{{captionTitle}}</span>
      <div class="d-flex" style="gap: 10px;">      
        <ng-container *ngTemplateOutlet="captionTemplate"></ng-container>
        @if(showExportExcelBtn){
          <flexi-button [className]="exportExcelBtnClass" (click)="onExportExcelButtonClick()">
            <i class="fa-solid fa-file-excel"></i>            
          </flexi-button>
        }
        @if(showColumnVisibility){
          <flexi-button [className]="columnVisibilityBtnClass" title="Column Visibility" (click)="toggleColumnVisibilityDropdown()">
            <i class="fa-solid fa-list-check cursor"></i>
            <div class="flexi-grid-dropdown-menu" [class.show]="columnVisibilityDropdownVisible()">
              <p class="flexi-grid-dropdown-title">Column Visibility</p>
              @for(column of columns; track $index){
                <label class="flexi-grid-dropdown-checkbox-item" [for]="column.field">
                  <input [(ngModel)]="column.visible" [id]="column.field" type="checkbox">
                  {{ column.title ? column.title : column.field }}
                </label>                    
              }                    
            </div>
          </flexi-button>
        }
        @if(showRefreshBtn || dataBinding){
          <flexi-button [className]="refreshDataBtnClass" (click)="refreshDataMethod()">
            <i class="fa-solid fa-arrow-rotate-right"></i>
          </flexi-button>
        }
        <div style="margin-right: 10px;"></div>
      </div>
    </div>
  }
  <div style="width: 100%; overflow-x: auto; position: relative">
    @if(loading){
      <div class="flexi-grid-spinner-container">
        <div class="flexi-grid-spinner-1"></div>
        <div class="flexi-grid-spinner-2"></div>
      </div>
    }
    <table class="flexi-grid-table"  [ngStyle]="{'min-width': !useMinWidth ? '100%' : minWidth}">
      <thead>     
        <tr>
          @if(showIndex){
            <th [ngStyle]="{'width': indexWidth, 'text-align': indexTextAlign}" style="text-align: center;">
              <span>#</span>
            </th>
          }
          @for(column of columns; track $index){          
            <th
              [draggable]="(draggable && column.draggable)"
              class="cursor flexi-grid-border"
              [hidden]="!column.visible"
              [ngStyle]="{'width': column.width}"
              (dragstart)="onDragStart($event, $index)"
              (dragover)="onDragOver($event, $index)"
              (drop)="onDrop($event, $index)">
              <div [ngClass]="setTextAlignForTh(filterable, column)">
                @if(resizable && column.resizable){
                  <div class="flexi-grid-resize-handle" (mousedown)="onMouseDown($event, column)"></div>
                }
                @if(sortable && column.sortable && column.field && data.length > 0){
                  <div (click)="sort(sortable,column)">
                    <span class="flexi-grid-th-title-span">{{ column.title ? column.title : column.field }}</span>
                    <span class="ms-2">
                      @if(state.sort.field === column.field){
                        <span>
                          {{ state.sort.dir === 'asc' ? '↑' : '↓' }}
                        </span>
                      }
                    </span>
                  </div>
                }@else {
                  <div>
                    <span>{{ column.title ? column.title : column.field }}</span>
                  </div>
                }
                @if(filterable && column.field && column.filterable && showFilterButton(column.filterType)){
                  <div class="p-relative">
                    <i class="fa-solid fa-filter svg cursor show-filter" (click)="toggleFilterDropdown(column.field)"></i>
                    @if(showClearFilter(column.filterValue)){
                      <i class="fa-solid fa-filter-circle-xmark svg cursor" (click)="clearFilter(column.field)"></i>
                    }
                    <div class="flexi-grid-dropdown-menu" [ngClass]="column.textAlign === 'right' ? 'flexi-grid-dropdown-menu-right' : ''" [class.show]="filterDropdownVisible()[column.field]">
                      @for(filterType of giveFilterValueByFilterType(column.filterType); track filterType.operator){
                        <a class="flexi-grid-dropdown-item" [ngClass]="column.filterOperator === filterType.operator ? 'flexi-grid-active' : ''" (click)="applyFilter(column, filterType.operator)">
                          {{ filterType.value }}
                        </a>
                      }
                    </div>
                  </div>
                }  
              </div>
          </th>
          }
          @if(showCommandColumn){
            <th [ngStyle]="{'width': commandColumnWidth, 'text-align': commandColumnTextAlign}" [ngClass]="stickyCommandColumn ? 'flexi-sticky-column' : ''">{{commandColumnTitle}}</th>
          }
        </tr>
        @if(filterable){
         <tr class="flexi-grid-mobile-filter-tr">
           <th colSpan="2">
             @if(isShowMobileFilter()){
               <button class="flexi-grid-btn" (click)="closeMobileFilter()">
                <i class="fa-solid fa-filter-circle-xmark cursor"></i>
                 Filtreyi Kapat
               </button>
             }@else {
               <button class="flexi-grid-btn" (click)="openMobileFilter()">
                <i class="fa-solid fa-filter cursor"></i>                 
                 Filtreyi Aç
               </button>
             }
           </th>
         </tr>
         <tr class="flexi-grid-filter-tr" #filterTr>
           @if(showIndex && !isShowMobileFilter()){
             <th class="flexi-grid-filter-th" [ngStyle]="{'width': indexWidth}" [ngStyle]="{}"></th>
           }
           @for(column of columns; track $index){
             @if(column.filterable && column.field){            
               <th class="flexi-grid-filter-th" [hidden]="!column.visible" [attr.data-label]="column.title ? column.title : column.field">
                 <div class="d-flex flexi-grid-filter-container">
                   @if(column.filterType === "text"){
                     <input class="flexi-grid-filter-input" type="search" [(ngModel)]="column.filterValue" (input)="filter(column.field, column.filterOperator, column.filterValue, column.filterType)">                     
                   }@else if(column.filterType === "date"){
                     <input class="flexi-grid-filter-input" type="date" [(ngModel)]="column.filterValue" (input)="filter(column.field, column.filterOperator, column.filterValue, column.filterType)">
                   }@else if(column.filterType === "date-time"){
                     <input class="flexi-grid-filter-input" type="datetime-local" [(ngModel)]="column.filterValue" (input)="filter(column.field, column.filterOperator, column.filterValue, column.filterType)">
                   }@else if(column.filterType === "number"){
                     <input class="flexi-grid-filter-input" type="search" [(ngModel)]="column.filterValue" (input)="filter(column.field, column.filterOperator, column.filterValue, column.filterType)">
                   }@else if(column.filterType === "select"){
                    <select class="flexi-grid-filter-select" [(ngModel)]="column.filterValue" (change)="filter(column.field, 'eq', column.filterValue, column.filterType)">
                      <option [value]="undefined">Seçim yapınız</option>
                      @for(data of column.filterData;track data.value){
                        <option [value]="data.value">{{data.name}}</option>
                      }
                    </select>
                   }@else if(column.filterType === "boolean" && column.booleanData.length > 0){
                    <select class="flexi-grid-filter-select" [(ngModel)]="column.filterValue" (change)="filter(column.field, 'eq', column.filterValue, column.filterType)">
                      <option [value]="undefined">Seçim yapınız</option>
                      <option [value]="true">{{column.booleanData[0]}}</option>
                      <option [value]="false">{{column.booleanData[1]}}</option>                      
                    </select>
                   }
                 </div>
               </th>
             }@else {
               @if(!isShowMobileFilter()){
                 <th [hidden]="!column.visible"></th>
               }
             }
           }
           @if(showCommandColumn){
            <th [ngClass]="stickyCommandColumn ? 'flexi-sticky-column' : ''"></th>
          }
         </tr>
       }    
      </thead>
      <tbody #tbody class="relative" [ngStyle]="getTBodyStyle()">        
        @if(data.length > 0){      
          @for(item of pagedData(); track $index; let i = $index){
            <tr [ngStyle]="{'min-height': trMinHeight}">
              @if(showIndex){
                <td class="flexi-grid-index-td" [ngStyle]="{'width': indexWidth, 'text-align': indexTextAlign}" [attr.data-label]="'#'">
                    @if(!pageable){
                      <span>{{($index + 1)}}</span>
                    }@else {
                      <span>{{($index + ((state.pageNumber -1) * +state.pageSize)) + 1}}</span>
                    }
                </td>                
              }
              @for(column of columns; track $index){
                @if(column.columnTemplate && column.visible){
                  <td [ngStyle]="{'width': column.width, 'text-align': column.textAlign}" [ngClass]="tdTemplateClassName(column)" [attr.data-label]="column.title ? column.title : column.field">
                    <ng-container *ngTemplateOutlet="column.columnTemplate; context: {value: item[column.field], item: item, index: i}"></ng-container>
                  </td>
                }@else {
                  <td [ngStyle]="{'width': column.width, 'text-align': column.textAlign}" [hidden]="!column.visible" [ngClass]="tdNoTemplateClassName(column)" [attr.data-label]="column.title ? column.title : column.field" [title]="item ? getFieldValue(item, column.field) : ''">
                    @if(column.field){
                      @if((column.filterType === "date" || column.filterType === "date-time") && column.filterType){
                        {{ getFieldValue(item, column.field) | date: column.format! }}
                      }@else if(column.filterType === "number" && column.filterType){
                        @if(column.format === "n" || column.format === null){
                          {{ (getFieldValue(item, column.field) | trCurrency: "": true: column.fraction) }}
                        }@else if(column.format === "c"){
                          {{ (getFieldValue(item, column.field) | trCurrency : column.symbol: column.showSymbolInFront: column.fraction) }}
                        }                    
                      }
                      @else if(column.filterType === "boolean"){
                        @if(column.showCheckbox){
                          <input class="flexi-grid-checkbox" type="checkbox" [checked]="getFieldValue(item, column.field)" (change)="getBooleanInputValue(item, column, $event)">                          
                        }@else {
                          @if(getFieldValue(item, column.field)){
                            <i class="fa-solid fa-check flexi-text-success"></i>
                          }@else {
                            <i class="fa-solid fa-x flexi-text-danger"></i>
                          }
                        }                        
                      }
                      @else {
                        {{ getFieldValue(item, column.field) }}
                      }
                    }
                  </td>
                }
              }
              @if(showCommandColumn){
                <td [ngStyle]="{'width': commandColumnWidth, 'text-align': commandColumnTextAlign}" [ngClass]="stickyCommandColumn ? 'flexi-sticky-column' : ''" [attr.data-label]="commandColumnTitle">
                  <ng-container *ngTemplateOutlet="commandColumnTemplate; context: {item: item, index: i}"></ng-container>
                </td>
              }
            </tr>
          }          
        }@else {
          @if(!loading){
            <tr style="height: 100%;" [ngStyle]="{'min-height': trMinHeight}">
              <td style="text-align: center;" [colSpan]="columns?.length">
                <h4>Gösterilecek veri bulunamadı!</h4>
              </td>
            </tr>
          }
        }
      </tbody>
      <tfoot>
        <ng-container *ngTemplateOutlet="footerTemplate" class="overflow-x"></ng-container>     
      </tfoot>
    </table>
  </div>
  @if(pageable){
    <div class="flexi-grid-pagination-container">
      @if(!isShowMobileFilter()){
        <div class="flexi-grid-pagination-part-one">
          <select class="flexi-grid-pagesize-select" [ngModel]="state.pageSize" (change)="changePageSize($event)">
            @for(size of pageSizeList; track size){
            <option>{{size}}</option>
            }
          </select>
        </div>
        <div class="flexi-grid-pagination-part-two">
          <ul class="flexi-grid-pagination">
            @if(this.pageNumbers().length > 1){              
              <li class="flexi-grid-page-item" [ngClass]="state.pageNumber === 1 ? 'disabled': ''" (click)="changePage(1)">
                <a class="flexi-grid-page-link" aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              <li class="flexi-grid-page-item" [ngClass]="state.pageNumber === 1 ? 'disabled': ''"
                (click)="changePage(state.pageNumber - 1)">
                <a class="flexi-grid-page-link" aria-label="Previous">
                  <span aria-hidden="true">&#8249;</span>
                </a>
              </li>
              @if(pageNumbers()[0] !== 1){
              <li class="flexi-grid-page-item" (click)="previousPageGroup()">
                <a class="flexi-grid-page-link">...</a>
              </li>
              }
              @for(pageNumber of pageNumbers(); track pageNumber){
              <li class="flexi-grid-page-item" [ngClass]="state.pageNumber === pageNumber ? 'flexi-grid-active': ''">
                <a (click)="changePage(pageNumber)" class="flexi-grid-page-link">
                  {{pageNumber}}
                </a>
              </li>
              }
              @if(pageNumbers()[pageNumbers().length - 1] !== totalPageCount()){
              <li class="flexi-grid-page-item" (click)="nextPageGroup()">
                <a class="flexi-grid-page-link">...</a>
              </li>
              }
              <li class="flexi-grid-page-item" [ngClass]="state.pageNumber === totalPageCount() ? 'disabled': ''"
                (click)="changePage(state.pageNumber + 1)">
                <a class="flexi-grid-page-link" aria-label="Next">
                  <span aria-hidden="true">&#8250;</span>
                </a>
              </li>
              <li class="flexi-grid-page-item" [ngClass]="state.pageNumber === totalPageCount() ? 'disabled': ''"
                (click)="changePage(totalPageCount())">
                <a class="flexi-grid-page-link" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            }
          </ul>        
        </div>
      }
      <div class="flexi-grid-pagination-part-third">
        <span> 
            {{state.pageNumber}} - {{totalPageCount()}} of {{(total | currency: '': '': '1.0')!.replace(',','.')}} items 
        </span>
      </div>
    </div>
  }
</div>